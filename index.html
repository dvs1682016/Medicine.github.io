<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¨‚é½¡ç”¨è—¥ç´€éŒ„</title>
    <!-- PWA ç›¸é—œè¨­å®š -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d9488">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="æ¨‚é½¡ç”¨è—¥">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0fdfa;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        .pill-card {
            transition: transform 0.1s;
        }
        .pill-card:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="bg-teal-50 text-slate-900">

    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col relative shadow-xl bg-white">
        
        <!-- é é¦–æ¨™é¡Œæ¬„ -->
        <header class="bg-teal-600 text-white p-4 shadow-md sticky top-0 z-10">
            <div class="flex justify-between items-center">
                <h1 id="page-title" class="text-2xl font-bold flex items-center text-white">
                    <span class="mr-2">â¤ï¸</span> æ¨‚é½¡ç”¨è—¥ç´€éŒ„
                </h1>
                <div id="offline-indicator" class="hidden text-xs bg-teal-800 px-2 py-1 rounded">é›¢ç·šæ¨¡å¼</div>
            </div>
            
            <!-- æ—¥æœŸåˆ‡æ›æ§åˆ¶é … -->
            <div id="date-controls" class="mt-4 flex items-center justify-between bg-teal-700/50 rounded-xl p-2">
                <button onclick="changeDate(-1)" class="p-2 w-12 text-center bg-teal-500/50 rounded-lg active:bg-teal-800 transition">
                    <i class="fas fa-chevron-left text-lg"></i>
                </button>
                <div id="current-display-date" class="text-xl font-bold tracking-wide text-center flex-grow">è¼‰å…¥ä¸­...</div>
                <button onclick="changeDate(1)" class="p-2 w-12 text-center bg-teal-500/50 rounded-lg active:bg-teal-800 transition">
                    <i class="fas fa-chevron-right text-lg"></i>
                </button>
            </div>
        </header>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <main class="flex-grow p-4 pb-28">
            <!-- æ¯æ—¥ç”¨è—¥æ¸…å–®è¦–åœ– -->
            <section id="view-daily">
                <div id="daily-list" class="space-y-4"></div>
            </section>

            <!-- è—¥å“ç®¡ç†è¦–åœ– -->
            <section id="view-settings" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold border-l-4 border-teal-500 pl-3 text-slate-700">è—¥å“æ’åºèˆ‡ç®¡ç†</h2>
                    <button onclick="openMedModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold shadow-sm active:scale-95 transition">
                        <i class="fas fa-plus mr-1"></i> æ–°å¢
                    </button>
                </div>
                <div id="med-list" class="space-y-3"></div>
            </section>

            <!-- è³‡æ–™å‚™ä»½è¦–åœ– -->
            <section id="view-data" class="hidden">
                <h2 class="text-xl font-bold border-l-4 border-teal-500 pl-3 mb-6 text-slate-700">è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h2>
                <div class="space-y-6">
                    <div class="bg-teal-50 p-5 rounded-2xl border border-teal-100 text-teal-800">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-file-export text-2xl mr-3"></i>
                            <h3 class="font-bold text-lg">åŒ¯å‡ºå‚™ä»½æª”</h3>
                        </div>
                        <p class="text-sm mb-4 text-teal-700">ä¸‹è¼‰ JSON æª”æ¡ˆå‚™ä»½è¨­å®šèˆ‡ç´€éŒ„ã€‚</p>
                        <button onclick="exportData()" class="w-full bg-teal-600 text-white py-3 rounded-xl font-bold active:scale-95 transition">ä¸‹è¼‰å‚™ä»½</button>
                    </div>

                    <div class="bg-slate-50 p-5 rounded-2xl border border-slate-200">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-file-import text-slate-600 text-2xl mr-3"></i>
                            <h3 class="font-bold text-lg text-slate-700">åŒ¯å…¥å‚™ä»½æª”</h3>
                        </div>
                        <label class="block w-full text-center bg-slate-600 text-white py-3 rounded-xl font-bold cursor-pointer active:scale-95 transition">
                            é¸å–æª”æ¡ˆä¸¦åŒ¯å…¥
                            <input type="file" id="import-file" class="hidden" accept=".json" onchange="handleImport(event)">
                        </label>
                    </div>
                </div>
            </section>
        </main>

        <!-- åº•éƒ¨å°è¦½æŒ‰éˆ• -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around p-2 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] safe-area-bottom max-w-md mx-auto z-20">
            <button onclick="toggleView('daily')" class="nav-btn flex flex-col items-center p-2 text-teal-600" id="nav-daily">
                <i class="fas fa-calendar-check text-2xl mb-1"></i>
                <span class="text-xs font-bold">æ¯æ—¥ç”¨è—¥</span>
            </button>
            <button onclick="toggleView('settings')" class="nav-btn flex flex-col items-center p-2 text-slate-400" id="nav-settings">
                <i class="fas fa-pills text-2xl mb-1"></i>
                <span class="text-xs font-bold">è—¥å“è¨­å®š</span>
            </button>
            <button onclick="toggleView('data')" class="nav-btn flex flex-col items-center p-2 text-slate-400" id="nav-data">
                <i class="fas fa-database text-2xl mb-1"></i>
                <span class="text-xs font-bold">è³‡æ–™ç®¡ç†</span>
            </button>
        </nav>

        <!-- è—¥å“ç·¨è¼¯å½ˆçª— -->
        <div id="med-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl">
                <div class="bg-slate-50 p-4 border-b flex justify-between items-center text-slate-700">
                    <h3 class="font-bold text-lg">è—¥å“è³‡è¨Šè¨­å®š</h3>
                    <button onclick="closeMedModal()"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="p-6 space-y-5">
                    <input type="text" id="input-name" placeholder="è—¥å“åç¨±" class="w-full border-2 p-3 rounded-xl text-xl focus:border-teal-400 outline-none">
                    <div class="flex space-x-3">
                        <input type="number" id="input-qty" value="1" class="w-1/2 border-2 p-3 rounded-xl text-xl outline-none">
                        <select id="input-unit" class="w-1/2 border-2 p-3 rounded-xl text-xl bg-white outline-none">
                            <option>é¡†</option><option>ç²’</option><option>åŒ…</option><option>æ¯«å‡</option>
                        </select>
                    </div>
                    <div class="flex space-x-3">
                        <select id="input-timing" class="w-1/2 border-2 p-3 rounded-xl text-xl bg-white outline-none">
                            <option>é£¯å¾Œ</option><option>é£¯å‰</option><option>éš¨é¤</option><option>ç¡å‰</option><option>ç©ºè…¹</option>
                        </select>
                        <select id="input-freq" class="w-1/2 border-2 p-3 rounded-xl text-xl bg-white outline-none">
                            <option value="1">1æ¬¡/å¤©</option><option value="2">2æ¬¡/å¤©</option><option value="3">3æ¬¡/å¤©</option><option value="4">4æ¬¡/å¤©</option>
                        </select>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 flex space-x-3">
                    <button onclick="closeMedModal()" class="flex-grow py-4 border-2 rounded-2xl font-bold text-slate-500">å–æ¶ˆ</button>
                    <button onclick="saveMedication()" class="flex-grow py-4 bg-teal-600 text-white rounded-2xl font-bold shadow-lg">å„²å­˜</button>
                </div>
            </div>
        </div>

        <!-- åˆªé™¤ç¢ºèªå½ˆçª— -->
        <div id="delete-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-8 text-center">
            <div class="bg-white rounded-3xl w-full max-w-xs overflow-hidden shadow-2xl">
                <div class="p-6">
                    <div class="w-16 h-16 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                    </div>
                    <h3 class="font-bold text-xl mb-2 text-slate-800">ç¢ºå®šè¦åˆªé™¤ï¼Ÿ</h3>
                    <p class="text-slate-500 text-sm">åˆªé™¤å¾Œç´€éŒ„å°‡ç„¡æ³•æ¢å¾©ã€‚</p>
                </div>
                <div class="flex border-t">
                    <button onclick="closeDeleteModal()" class="w-1/2 py-4 font-bold text-slate-400 border-r active:bg-slate-50">å–æ¶ˆ</button>
                    <button id="confirm-delete-btn" class="w-1/2 py-4 font-bold text-rose-500 active:bg-rose-50">åˆªé™¤</button>
                </div>
            </div>
        </div>

        <!-- ä¿®æ”¹æœè—¥æ™‚é–“å½ˆçª— -->
        <div id="time-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl">
                <div class="bg-slate-50 p-4 border-b flex justify-between items-center text-slate-700">
                    <h3 class="font-bold text-lg">ä¿®æ”¹æœè—¥æ™‚é–“</h3>
                    <button onclick="closeTimeModal()"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="p-6 space-y-5 text-center">
                    <p class="text-slate-500 text-sm">è«‹é¸æ“‡æ­£ç¢ºçš„æœç”¨æ™‚é–“ï¼š</p>
                    <input type="time" id="input-edit-time" class="w-full border-2 p-4 rounded-2xl text-3xl text-center focus:border-teal-400 outline-none bg-slate-50">
                </div>
                <div class="p-4 bg-slate-50 flex space-x-3">
                    <button onclick="closeTimeModal()" class="flex-grow py-4 border-2 rounded-2xl font-bold text-slate-500">å–æ¶ˆ</button>
                    <button onclick="updateRecordTime()" class="flex-grow py-4 bg-teal-600 text-white rounded-2xl font-bold shadow-lg">ç¢ºèªä¿®æ”¹</button>
                </div>
            </div>
        </div>

        <!-- æç¤ºè¨Šæ¯ -->
        <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-slate-800/90 text-white px-8 py-3 rounded-full text-base font-bold opacity-0 transition-opacity pointer-events-none z-50 shadow-lg">å·²å®Œæˆ</div>
    </div>

    <script>
        // PWA Service Worker è¨»å†Š
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const isSupportedProtocol = window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                if (isSupportedProtocol) {
                    navigator.serviceWorker.register('./sw.js')
                        .then(reg => console.log('PWA SW Registered'))
                        .catch(err => { if (err.name !== 'SecurityError') console.error('PWA SW Failed', err); });
                }
            });
        }

        // ç›£æ¸¬ç¶²è·¯ç‹€æ…‹
        window.addEventListener('online', updateStatus);
        window.addEventListener('offline', updateStatus);
        function updateStatus() {
            const indicator = document.getElementById('offline-indicator');
            if (indicator) indicator.classList.toggle('hidden', navigator.onLine);
        }

        // --- è³‡æ–™ç®¡ç†é‚è¼¯ ---
        let meds = JSON.parse(localStorage.getItem('elderly_meds')) || [];
        let records = JSON.parse(localStorage.getItem('elderly_records')) || [];
        let currentDate = new Date();
        let lastCheckedDate = new Date().toDateString(); // ç”¨æ–¼è·¨å¤©åµæ¸¬
        let currentView = 'daily';
        let editingId = null;
        let pendingDeleteId = null;
        let pendingTimeEdit = null; // å­˜æ”¾å¾…ä¿®æ”¹æ™‚é–“çš„è³‡è¨Š {medId, doseIndex, date}

        window.onload = () => {
            updateStatus();
            updateDateDisplay();
            render();
            // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡æ˜¯å¦è·¨éå‡Œæ™¨ 12 é»
            setInterval(checkMidnightReset, 60000);
        };

        // è·¨åˆå¤œåµæ¸¬é‚è¼¯
        function checkMidnightReset() {
            const now = new Date();
            if (now.toDateString() !== lastCheckedDate) {
                lastCheckedDate = now.toDateString();
                // å¦‚æœç›®å‰æ˜¯åœ¨çœ‹ç•¶æ—¥åˆ—è¡¨ï¼Œè‡ªå‹•è·³è½‰åˆ°æ–°çš„ä¸€å¤©
                currentDate = new Date();
                updateDateDisplay();
                render();
                showToast("ğŸ“… å·²è‡ªå‹•é‡ç½®è‡³ä»Šæ—¥ç”¨è—¥æ¸…å–®");
            }
        }

        function saveToStorage() {
            localStorage.setItem('elderly_meds', JSON.stringify(meds));
            localStorage.setItem('elderly_records', JSON.stringify(records));
        }

        // --- ä»‹é¢åˆ‡æ› ---
        function toggleView(view) {
            currentView = view;
            ['view-daily', 'view-settings', 'view-data'].forEach(id => document.getElementById(id).classList.add('hidden'));
            ['nav-daily', 'nav-settings', 'nav-data'].forEach(id => {
                const btn = document.getElementById(id);
                btn.classList.remove('text-teal-600');
                btn.classList.add('text-slate-400');
            });
            
            document.getElementById(`view-${view}`).classList.remove('hidden');
            document.getElementById(`nav-${view}`).classList.replace('text-slate-400', 'text-teal-600');
            document.getElementById('date-controls').classList.toggle('hidden', view !== 'daily');
            render();
        }

        function changeDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            updateDateDisplay();
            render();
        }

        function updateDateDisplay() {
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'long' };
            const display = document.getElementById('current-display-date');
            if (display) display.innerText = currentDate.toLocaleDateString('zh-TW', options);
        }

        // --- ç•«é¢æ¸²æŸ“é‚è¼¯ ---
        function render() {
            if (currentView === 'daily') renderDaily();
            else if (currentView === 'settings') renderSettings();
        }

        function renderDaily() {
            const list = document.getElementById('daily-list');
            list.innerHTML = '';
            const dateKey = currentDate.toISOString().split('T')[0];
            
            if (meds.length === 0) {
                list.innerHTML = `<div class="text-center py-20 text-slate-400 font-bold">è«‹å…ˆé»æ“Šä¸‹æ–¹ã€Œè—¥å“è¨­å®šã€æ–°å¢è³‡æ–™</div>`;
                return;
            }

            meds.forEach(med => {
                for (let i = 0; i < med.freq; i++) {
                    const record = records.find(r => r.date === dateKey && r.medId === med.id && r.doseIndex === i);
                    const isTaken = !!record;
                    const card = document.createElement('div');
                    card.className = `pill-card flex items-center p-4 rounded-2xl shadow-sm border-2 transition-all ${isTaken ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-teal-100/50'}`;
                    
                    // ä¿®æ”¹æ™‚é–“çš„ HTML
                    const timeDisplay = isTaken ? 
                        `<span onclick="openTimeModal('${med.id}', ${i}, '${dateKey}', '${record.time}')" class="ml-1 text-emerald-600 underline decoration-dotted underline-offset-4 cursor-pointer">
                            <i class="fas fa-check-circle mr-1"></i>æ–¼ ${record.time} æœç”¨
                         </span>` : 
                        `<span class="ml-2 text-rose-400 italic font-normal">å°šæœªæœç”¨</span>`;

                    card.innerHTML = `
                        <div class="flex-grow">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-xl">${med.name}</span>
                                <span class="text-xs px-2 py-1 rounded-full font-bold ${isTaken ? 'bg-emerald-200 text-emerald-700' : 'bg-teal-100 text-teal-600'}">ç¬¬ ${i+1} æ¬¡ / ${med.timing}</span>
                            </div>
                            <div class="mt-1 text-slate-500 font-bold text-sm">
                                æ¯æ¬¡ ${med.qty}${med.unit} ${timeDisplay}
                            </div>
                        </div>
                        <button onclick="toggleRecord('${med.id}', ${i})" class="w-16 h-16 rounded-2xl flex items-center justify-center shadow-sm transition-all ${isTaken ? 'bg-emerald-500 text-white shadow-emerald-200' : 'bg-slate-100 text-slate-400'}">
                            <i class="fas ${isTaken ? 'fa-check' : 'fa-plus'} text-2xl"></i>
                        </button>
                    `;
                    list.appendChild(card);
                }
            });
        }

        function renderSettings() {
            const list = document.getElementById('med-list');
            list.innerHTML = '';
            meds.forEach((med, index) => {
                const item = document.createElement('div');
                item.className = 'bg-white p-5 rounded-2xl border flex justify-between items-center shadow-sm';
                item.innerHTML = `
                    <div class="flex items-center space-x-3 mr-2 text-slate-700">
                        <div class="flex flex-col space-y-2">
                            <button onclick="moveMed(${index}, -1)" class="p-1 text-slate-400 hover:text-teal-600 ${index === 0 ? 'opacity-20 pointer-events-none' : ''}">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button onclick="moveMed(${index}, 1)" class="p-1 text-slate-400 hover:text-teal-600 ${index === meds.length - 1 ? 'opacity-20 pointer-events-none' : ''}">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div>
                            <div class="font-bold text-xl">${med.name}</div>
                            <div class="text-sm text-teal-600 font-bold mt-1">${med.timing} Â· æ¯å¤© ${med.freq} æ¬¡ Â· ${med.qty}${med.unit}</div>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editMed('${med.id}')" class="w-11 h-11 text-teal-600 bg-teal-50 rounded-xl flex items-center justify-center"><i class="fas fa-edit"></i></button>
                        <button onclick="confirmDeleteMed('${med.id}')" class="w-11 h-11 text-rose-600 bg-rose-50 rounded-xl flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // --- æ’åºåŠŸèƒ½ ---
        function moveMed(index, direction) {
            const targetIndex = index + direction;
            if (targetIndex < 0 || targetIndex >= meds.length) return;
            const temp = meds[index];
            meds[index] = meds[targetIndex];
            meds[targetIndex] = temp;
            saveToStorage();
            renderSettings();
            showToast("å·²èª¿æ•´é †åº");
        }

        // --- åŠŸèƒ½é‚è¼¯ ---
        function toggleRecord(medId, doseIndex) {
            const dateKey = currentDate.toISOString().split('T')[0];
            const idx = records.findIndex(r => r.date === dateKey && r.medId === medId && r.doseIndex === doseIndex);
            if (idx > -1) {
                records.splice(idx, 1);
                showToast("å·²å–æ¶ˆç´€éŒ„");
            } else {
                const time = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
                records.push({ date: dateKey, medId, doseIndex, time });
                showToast("ğŸ’Š æœè—¥ç´€éŒ„æˆåŠŸ");
            }
            saveToStorage(); render();
        }

        // ä¿®æ”¹æ™‚é–“å°ˆç”¨ Modal
        function openTimeModal(medId, doseIndex, date, currentTime) {
            pendingTimeEdit = { medId, doseIndex, date };
            document.getElementById('input-edit-time').value = currentTime;
            document.getElementById('time-modal').classList.remove('hidden');
            // é˜²æ­¢é»æ“Šæ™‚é–“è§¸ç™¼å¤–å±¤çš„ toggleRecord
            event.stopPropagation();
        }

        function closeTimeModal() {
            document.getElementById('time-modal').classList.add('hidden');
            pendingTimeEdit = null;
        }

        function updateRecordTime() {
            if (!pendingTimeEdit) return;
            const newTime = document.getElementById('input-edit-time').value;
            if (!newTime) return;

            const idx = records.findIndex(r => 
                r.date === pendingTimeEdit.date && 
                r.medId === pendingTimeEdit.medId && 
                r.doseIndex === pendingTimeEdit.doseIndex
            );

            if (idx > -1) {
                records[idx].time = newTime;
                saveToStorage();
                renderDaily();
                showToast("âœ… æœè—¥æ™‚é–“å·²æ›´æ–°");
            }
            closeTimeModal();
        }

        function openMedModal(id = null) {
            editingId = id;
            if (id) {
                const m = meds.find(x => x.id === id);
                ['name', 'qty', 'unit', 'timing', 'freq'].forEach(k => document.getElementById(`input-${k}`).value = m[k]);
            } else { 
                document.getElementById('input-name').value = ''; 
                document.getElementById('input-qty').value = 1; 
            }
            document.getElementById('med-modal').classList.remove('hidden');
        }

        function closeMedModal() { document.getElementById('med-modal').classList.add('hidden'); }

        function saveMedication() {
            const name = document.getElementById('input-name').value.trim();
            if (!name) return showToast("è«‹è¼¸å…¥è—¥å");
            const data = { 
                id: editingId || Date.now().toString(), 
                name, 
                qty: document.getElementById('input-qty').value, 
                unit: document.getElementById('input-unit').value, 
                timing: document.getElementById('input-timing').value, 
                freq: parseInt(document.getElementById('input-freq').value) 
            };
            if (editingId) {
                const idx = meds.findIndex(m => m.id === editingId);
                meds[idx] = data;
            } else {
                meds.push(data);
            }
            saveToStorage(); closeMedModal(); render(); showToast("è¨­å®šå·²å„²å­˜");
        }

        function confirmDeleteMed(id) {
            pendingDeleteId = id;
            document.getElementById('delete-modal').classList.remove('hidden');
            document.getElementById('confirm-delete-btn').onclick = () => {
                meds = meds.filter(m => m.id !== pendingDeleteId);
                saveToStorage(); closeDeleteModal(); render(); showToast("å·²åˆªé™¤è—¥å“");
            };
        }
        function closeDeleteModal() { document.getElementById('delete-modal').classList.add('hidden'); }
        function editMed(id) { openMedModal(id); }

        function exportData() {
            const blob = new Blob([JSON.stringify({meds, records}, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æ¨‚é½¡ç”¨è—¥å‚™ä»½_${new Date().toLocaleDateString()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast("å‚™ä»½ä¸‹è¼‰ä¸­");
        }

        function handleImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const d = JSON.parse(ev.target.result);
                    if (d.meds) { 
                        meds = d.meds; 
                        records = d.records || []; 
                        saveToStorage(); 
                        showToast("è³‡æ–™é‚„åŸæˆåŠŸ");
                        toggleView('daily'); 
                    }
                } catch(err) { showToast("éŒ¯èª¤ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º"); }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            if (t) {
                t.innerText = msg;
                t.style.opacity = '1';
                setTimeout(() => t.style.opacity = '0', 2000);
            }
        }
    </script>
</body>
</html>